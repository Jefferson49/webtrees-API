<?php

declare(strict_types=1);

namespace Jefferson49\Webtrees\Module\WebtreesApi;

use Fisharebest\Webtrees\Http\RequestHandlers\ControlPanel;
use Fisharebest\Webtrees\I18N;
use Fisharebest\Webtrees\View;
use Jefferson49\Webtrees\Internationalization\MoreI18N;
use Jefferson49\Webtrees\Module\WebtreesApi\WebtreesApi;

use function e;


/**
 * @var string      $title
 * @var bool        $pretty_urls
 * @var WebtreesApi $webtrees_api
 * @var string      $webtrees_api_token
 */

?>

<?= view('components/breadcrumbs', ['links' => [
    route(ControlPanel::class) => MoreI18N::xlate('Control panel'),
    $webtrees_api->getConfigLink() => $webtrees_api->title(),
    $title
    ]]) ?>

<title><?=e($title) ?></title>

<link rel="stylesheet" type="text/css" href="<?= e($webtrees_api->assetUrl('css/swagger-ui.css')) ?>">

<?php if (!$pretty_urls) : ?>
	<?= view('components/' . 'alert-danger', [
		'alert' => I18N::translate('The API can only be tested with "pretty" URLs enabled. Check the <a href="https://webtrees.net/faq/urls/" target="_blank">webtrees documentation</a> about how to enable "pretty" URLs.'),
	]) ?>
<?php else : ?>
	<div id="swagger-ui"></div>
<?php endif	?>

<style>
.swagger-ui .auth-wrapper {
    display: none!important;
}
</style>

<?php View::push('javascript') ?>

<script src="<?= e($webtrees_api->assetUrl('js/swagger-ui-bundle.js')) ?>"></script>
<script src="<?= e($webtrees_api->assetUrl('js/swagger-ui-standalone-preset.js')) ?>"></script>

<script>
 window.onload = function () {
    const tokenFromServer = "<?= e($webtrees_api_token) ?>";
    const token = tokenFromServer || null;
    
    // Plugin to mask token in CURL command display
    const maskTokenPlugin = () => ({
        statePlugins: {
            spec: {
                selectors: {
                    requestFor: (state) => state.get('request')
                }
            }
        },
        components: {
            CurlCommand: {
                render(props) {
                    let curlCommand = props.command || '';
                    if (token) {
                        curlCommand = curlCommand.replace(new RegExp(token, 'g'), '<ACCESS-TOKEN>');
                    }
                    return curlCommand;
                }
            }
        }
    });
    
    const ui = SwaggerUIBundle({
        url: "<?= e($webtrees_api->assetUrl('OpenApi/OpenApi.json')) ?>",
        dom_id: '#swagger-ui',
        presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
        plugins: [SwaggerUIBundle.plugins.DownloadUrl, maskTokenPlugin],
        requestInterceptor: (req) => {
            if (token) {
                req.headers = req.headers || {};
                req.headers['Authorization'] = 'Bearer ' + token;
            }
            return req;
        }
    });
    
    // Observe DOM changes and mask token in displayed CURL commands
    const observer = new MutationObserver(() => {
        const curlElements = document.querySelectorAll('.curl');
        curlElements.forEach(el => {
            if (token && el.textContent.includes(token)) {
                el.textContent = el.textContent.replace(new RegExp(token, 'g'), '<ACCESS-TOKEN>');
            }
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
    
    window.ui = ui;
};
</script>

<?php View::endpush() ?>
