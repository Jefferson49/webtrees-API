<?php

declare(strict_types=1);

namespace Jefferson49\Webtrees\Module\ExtendedImportExport;

use Fisharebest\Webtrees\I18N;
use Fisharebest\Webtrees\View;
use Jefferson49\Webtrees\Module\WebtreesApi\WebtreesApi;

use function e;


/**
 * @var string      $title
 * @var bool        $pretty_urls
 * @var WebtreesApi $webtrees_api
 * @var string      $webtrees_api_token 
 */

?>
<title><?=e($title) ?></title>

<link rel="stylesheet" type="text/css" href="<?= e($webtrees_api->assetUrl('css/swagger-ui.css')) ?>">

<?php if (!$pretty_urls) : ?>
	<?= view('components/' . 'alert-danger', [
		'alert' => I18N::translate('The API can only be tested with "pretty" URLs enabled. Check the <a href="https://webtrees.net/faq/urls/" target="_blank">webtrees documentation</a> about how to enable "pretty" URLs.'),
	]) ?>
<?php else : ?>
	<div id="swagger-ui"></div>
<?php endif	?>

<?php View::push('javascript') ?>

<script src="<?= e($webtrees_api->assetUrl('js/swagger-ui-bundle.js')) ?>"></script>
<script src="<?= e($webtrees_api->assetUrl('js/swagger-ui-standalone-preset.js')) ?>"></script>

<script>
window.onload = function() {
	const tokenFromServer = "<?= e($webtrees_api_token) ?>";
	const token = tokenFromServer || null;

	const ui = SwaggerUIBundle({
		url: "<?= e($webtrees_api->assetUrl('OpenApi/OpenApi.json')) ?>",
		dom_id: '#swagger-ui',
		presets: [
			SwaggerUIBundle.presets.apis,
			SwaggerUIStandalonePreset
		],
		requestInterceptor: (req) => {
			if (token) {
				req.headers = req.headers || {};
				req.headers['Authorization'] = 'Bearer ' + token;
			}
			return req;
		}
	});

	if (token && typeof ui.preauthorizeApiKey === 'function') {
		try {
			ui.preauthorizeApiKey('bearerAuth', token);
		} catch (e) { }
	}

	window.ui = ui;
};
</script>

<?php View::endpush() ?>